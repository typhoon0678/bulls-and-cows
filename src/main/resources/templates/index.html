<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Bulls And Cows</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <!--    <link href="/css/bootstrap.min.css" rel="stylesheet">-->
  <!--    <script src="/js/bootstrap.bundle.min.js"></script>-->
  <!--    <script src="/js/jquery-3.7.1.min.js"></script>-->
</head>
<body>

<!--<header th:replace="/header :: header"></header>-->

<main class="container-fluid">

  <div class="mh-100" style="height: 200px;">
    <div class="d-flex justify-content-around">
      <div class="container d-flex justify-content-center my-4" id="div-info" style="font-size: 24px"></div>
      <div class="container d-flex justify-content-center my-4" id="div-score" style="font-size: 24px"></div>
    </div>

    <a class="btn btn-primary d-flex justify-content-center m-3" id="btn-play">Play</a>
    <a class="btn btn-outline-primary d-flex justify-content-center m-3" id="btn-next">Next</a>
  </div>

  <div class="row">
    <th:block th:each="i : ${#numbers.sequence(1, 5)}">
      <div class="m-2 border border-secondary container-fluid"
           style="display: block; width: 300px; height: 200px;"
           th:id="'div-try-' + ${i}">
        <div class="row h-50">
          <th:block th:each="j : ${#numbers.sequence(1, 3)}">
            <div class="col border border-primary d-flex align-items-center justify-content-center">
              <img th:id="'img-circle-' + ${i} + '-' + ${j}"
                   src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNgYAAAAAMAASsJTYQAAAAASUVORK5CYII="
                   th:alt="'circle-' + ${j}">
            </div>
          </th:block>
        </div>
        <div class="row h-50">
          <th:block th:each="j : ${#numbers.sequence(1, 3)}">
            <div class="col border border-primary d-flex align-items-center justify-content-center"
            ><h3 th:id="'judge-' + ${i} + '-' + ${j}" style="-webkit-text-stroke: 0.4px black;"></h3>
            </div>
          </th:block>
        </div>
      </div>
    </th:block>
  </div>

  <div class="container-fluid d-flex justify-content-center">
    <th:block th:each="i : ${#numbers.sequence(0, 9)}">
      <button class="btn btn-outline-primary m-2" th:id="'btn-num-' + ${i}">[[${i}]]</button>
    </th:block>
  </div>

  <div class="container-fluid mh-100" style="height: 120px;">
    <div class="container-fluid d-flex justify-content-center">
      <button class="btn btn-primary m-3" id="btn-num-submit">Submit</button>
      <button class="btn btn-danger m-3" id="btn-num-reset">Reset</button>
    </div>
  </div>
</main>

<script th:inline="javascript">

  var gameID = 0;
  var userID = 9;
  var tryCount = -1
  var score = 0;

  var fillNumIndex = 1;
  var dataNumList = [1, 2, 3];
  var dataNum = "123";

  var stage = 1;

  const divTryIDHead = "#div-try-";
  var divTryID = divTryIDHead + "1";

  const imgSrcHead = "../static/image/circle-";
  const imgFormat = ".png";
  var imgSrc = imgSrcHead + "1" + imgFormat;

  const imgCircleIDHead = "#img-circle-";
  var imgCircleID = imgCircleIDHead + "1" + "-" + "1";
  var imgCircleList = [];
  for (let i = 1; i <= 5; i++) {
    for (let j = 1; j <= 3; j++) {
      imgCircleList.push($(divTryIDHead + i + " " + imgCircleIDHead + i + "-" + j));
    }
  }

  const divJudgeIDHead = "#judge-";
  var divJudgeID = divJudgeIDHead + "1" + "-" + "1";
  var divJudgeList = [];
  for (let i = 1; i <= 5; i++) {
    for (let j = 1; j <= 3; j++) {
      divJudgeList.push($(divTryIDHead + i + " " + divJudgeIDHead + i + "-" + j));
    }
  }

  const btnNumIDHead = "#btn-num-";
  var btnNumID = btnNumIDHead + "1";
  var btnNumList = [];
  for (let i = 0; i <= 9; i++) {
    btnNumList.push($(btnNumIDHead + i));
  }

  const emptyPNG = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=";


  $.each(btnNumList, function (index, btnNum) {
    btnNum.on("click", function () {
      if (fillNumIndex > 3) return;

      imgSrc = imgSrcHead + index + imgFormat
      divTryID = divTryIDHead + (6 - tryCount);
      imgCircleID = imgCircleIDHead + (6 - tryCount) + "-" + fillNumIndex;

      $(divTryID + " " + imgCircleID).attr("src", imgSrc);

      dataNumList[fillNumIndex - 1] = index;

      fillNumIndex++;
    });
  });


  $("#btn-num-reset").on("click", function () {
    divTryID = divTryIDHead + (6 - tryCount);

    for (let i = 1; i <= 3; i++) {
      imgCircleID = imgCircleIDHead + (6 - tryCount) + "-" + i;

      $(divTryID + " " + imgCircleID).attr("src", emptyPNG);

      fillNumIndex = 1;
    }
  });

  $("#btn-num-submit").on("click", function () {
    if (fillNumIndex <= 3) return;

    dataNum = dataNumList[0].toString() + dataNumList[1].toString() + dataNumList[2].toString();

    $.ajax({
      url: "/api/checkNum",
      type: "post",
      contentType: 'application/json; charset=utf-8',
      data: JSON.stringify({
        "gameOption": "continue",
        "gameID": gameID,
        "userID": userID,
        "num": dataNum
      }),
      success: function (res) {

        responseLog(res);
        fillNumIndex = 1;

        var divTryID = divTryIDHead + (6 - tryCount);

        for (let i = 1; i <= 3; i++) {
          var divJudgeID = divJudgeIDHead + (6 - tryCount) + "-" + i;

          if (i <= res.judgement[0]) {
            $(divTryID + " " + divJudgeID).text("Strike");
            $(divTryID + " " + divJudgeID).css("color", "green");
          } else if (i <= res.judgement[0] + res.judgement[1]) {
            $(divTryID + " " + divJudgeID).text("Ball");
            $(divTryID + " " + divJudgeID).css("color", "yellow");
          } else {
            $(divTryID + " " + divJudgeID).text("Out");
            $(divTryID + " " + divJudgeID).css("color", "red");
          }
        }

        if (res.gameResult === "continue") {
          tryCount -= 1; // tryCount = res.tryCount;

          updateInfoScore("Stage " + stage, score);

        } else if (res.gameResult === "next") {
          tryCount = -1;
          score += res.addScore;

          updateInfoScore("Next Stage", score);

          $("#btn-next").css("visibility", "visible");

        } else if (res.gameResult === "gameOver") {
          tryCount = -1;
          console.log("gameOver");

          $("#div-score").text("GameOver");
          updateInfoScore("GameOver", res.totalScore);
          $("#btn-play").css("visibility", "visible");

        } else {
          alert("Error");
        }

      },
      error: function (res) {
        alert(res);
      }
    });
  });

  $("#btn-play").on("click", function () {
    $.ajax({
      url: "/api/checkNum",
      type: "post",
      contentType: 'application/json; charset=utf-8',
      data: JSON.stringify({
        "gameOption": "new",
        "gameID": gameID,
        "userID": userID,
        "num": "111"
      }),
      success: function (res) {
        responseLog(res);

        gameID = res.gameID;
        tryCount = 5; // tryCount = res.tryCount;
        fillNumIndex = 1;
        stage = 1;
        updateInfoScore("Stage " + 1, 0);
        resetImgAndJudge();

        $("#btn-play").css("visibility", "hidden");

      },
      error: function (res) {
         console.log(res.data);
        alert(res);
      }
    });
  });

  $("#btn-next").on("click", function () {
    $.ajax({
      url: "/api/checkNum",
      type: "post",
      contentType: 'application/json; charset=utf-8',
      data: JSON.stringify({
        "gameOption": "next",
        "gameID": gameID,
        "userID": userID,
        "num": "111"
      }),
      success: function (res) {
        responseLog(res);

        gameID = res.gameID;
        tryCount = 5; // tryCount = res.tryCount;
        fillNumIndex = 1;
        stage++;

        updateInfoScore("Stage : " + stage, res.totalScore);
        resetImgAndJudge();

        $("#btn-next").css("visibility", "hidden");

      },
      error: function (res) {
        alert(res);
      }
    });
  });


  function resetImgAndJudge() {
    $.each(imgCircleList, function (index, imgCircle) {
      imgCircle.attr("src", emptyPNG);
    });

    $.each(divJudgeList, function (index, divJudge) {
      divJudge.text("");
    });
  }

  function responseLog(res) {
    console.log("-------------------------------");
    console.log("gameID : " + res.gameID);
    console.log("userID : " + res.userID);
    console.log("addScore : " + res.addScore);
    console.log("totalScore : " + res.totalScore);
    console.log("tryCount : " + res.tryCount);
    console.log("gameResult : " + res.gameResult);
    console.log("judgement : " + res.judgement);
    console.log("--------------------------------");
  }

  function updateInfoScore(info, score) {
    $("#div-info").text(info);
    $("#div-score").text("Score : " + score);
  }

  $("#btn-next").css("visibility", "hidden");

</script>

</body>
</html>